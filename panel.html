<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Kullanım Durumu</title>
<style>
  body {
    font-family: 'Montserrat', sans-serif;
    background: linear-gradient(135deg, #1a1a1a, #2c3e50);
    color: #ecf0f1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin:0;
  }
  canvas { 
    background: #2c3e50; 
    border-radius:50%; 
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
  }
  h2 { margin-bottom:20px; color:#fff; }
  p { margin-top:12px; font-size:16px; text-align:center; }
</style>
</head>
<body>

<h2>Firebase Kullanım Durumu</h2>
<canvas id="usageCircle" width="250" height="250"></canvas>
<p id="usageText">Hesaplanıyor...</p>
<script src="engel.js"></script>
<script type="module">
import { firebaseConfig } from './config.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";



const app = initializeApp(firebaseConfig);
const db = getDatabase(app);


const TOTAL_QUOTA_GB = 1; // Kota
const mainPaths = [
  "D BLOKqrcodes","E BLOKqrcodes","admin","adminLogs","announcements",
  "devices","devriyeHistory","devriyeRecords","devriyeler","kargoDeliveries",
  "messages","nobetDurumu","nobetNoktalari","nobetRecords","qrCodes",
  "qrNoktas","securityEvents","CEM GAZI ARSLAN","-OZXFS4fj6MJMDUldzcM",
  "-OZXFW269wHbq8u1tIaE","tamamnbt"
];

const canvas = document.getElementById("usageCircle");
const ctx = canvas.getContext("2d");
const usageText = document.getElementById("usageText");

async function calculateUsage(){
  let totalBytes = 0;

  for(const path of mainPaths){
    try {
      const snapshot = await get(ref(db, path));
      const val = snapshot.val();
      if(val){
        const jsonString = JSON.stringify(val);
        totalBytes += new Blob([jsonString]).size;
      }
    } catch(e){
      console.warn("Path alınamadı:", path, e);
    }
  }

  const totalMB = totalBytes / (1024*1024);
  const totalGB = totalMB / 1024;
  const usagePercent = totalGB / TOTAL_QUOTA_GB;

  animateDonut(usagePercent, totalMB);
}

// Animasyonlu donut çizimi
function animateDonut(targetPercent, totalMB){
  let startPercent = 0;
  const radius = 100;
  const center = 125;
  const animation = setInterval(()=>{
    if(startPercent >= targetPercent){
      clearInterval(animation);
      return;
    }
    startPercent += 0.01;
    drawDonut(startPercent, totalMB);
  }, 10);
}

function drawDonut(percent, totalMB){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Arka plan daire
  ctx.beginPath();
  ctx.arc(125,125,100,0,2*Math.PI);
  ctx.fillStyle = "#ffffff10";
  ctx.fill();

  // Kullanım alanı
  let usageColor = "#27ae60"; // yeşil
  if(percent>0.3) usageColor = "#f39c12"; // turuncu
  if(percent>0.7) usageColor = "#c0392b"; // kırmızı

  ctx.beginPath();
  ctx.moveTo(125,125);
  ctx.arc(125,125,100,-0.5*Math.PI, (-0.5 + 2*percent)*Math.PI);
  ctx.fillStyle = usageColor;
  ctx.fill();

  // Ortadaki daire
  ctx.beginPath();
  ctx.arc(125,125,60,0,2*Math.PI);
  ctx.fillStyle = "#2c3e50";
  ctx.fill();

  // Yüzde metni
  ctx.fillStyle = "#ecf0f1";
  ctx.font = "bold 24px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(`${(percent*100).toFixed(1)}%`,125,125);

  // Alt metin
  usageText.innerHTML = `Kullanım: ${totalMB.toFixed(2)} MB<br>Kota: ${TOTAL_QUOTA_GB} GB`;
}

// Canlı güncelleme (10 saniye)
calculateUsage();
setInterval(calculateUsage, 10000);
</script>

</body>
</html>
