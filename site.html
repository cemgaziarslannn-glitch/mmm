<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA Güvenlik Sistemi - Site Sakini Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #1f3c59, #2c5364); color:#ecf0f1; }
.container { max-width: 1000px; margin:20px auto; padding:20px; position: relative; }
h1,h2 { text-align:center; margin-bottom:0; }
.panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); margin-top:20px; position:relative; }
.status { margin-top:10px; padding:15px; background: rgba(0,0,0,0.2); border-radius:12px; font-size:15px; line-height:1.5; }
.devriye-list { max-height:450px; overflow-y:auto; margin-top:10px; }
.devriye-item { display:flex; flex-direction:column; background: rgba(0,0,0,0.2); border-radius:12px; margin-bottom:12px; padding:12px; transition:0.3s; }
.devriye-item:hover { background: rgba(0,0,0,0.35); }
.devriye-left { flex:1; min-width:180px; margin-right:10px; }
.devriye-status { font-weight:bold; font-size:16px; text-align:center; min-width:140px; padding:8px; border-radius:12px; margin-top:10px; }
.devriye-status.tam { background: #2ecc71; color:#fff; }
.devriye-status.eksik { background: #e74c3c; color:#fff; }
.devriye-points { margin-top:8px; font-size:14px; background: rgba(255,255,255,0.05); padding:6px; border-radius:8px; }

.security-item { display:flex; align-items:center; justify-content: space-between; background: rgba(0,0,0,0.2); padding:8px 12px; border-radius:10px; margin-bottom:6px; font-size:15px; }
.security-item:hover { background: rgba(0,0,0,0.35); }
.security-left { display:flex; align-items:center; gap:10px; }
.security-light { width:10px; height:10px; background:#2ecc71; border-radius:50%; flex-shrink:0; }
.security-name { font-weight:600; }

input[type=date], input[type=password], input[type=text] { padding:6px; border-radius:8px; border:none; outline:none; margin-top:5px; }

#profileModal { display:none; position:fixed; top:50%; left:50%; transform: translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px; }
#profileModal h3 { text-align:center; margin-bottom:10px; }
#profileModal label { display:block; margin-top:10px; font-size:14px; text-transform: uppercase; } 
#profileModal input { width:100%; }
#profileModal button { margin-top:15px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
#updatePasswordBtn { background:#27ae60; color:#fff; }
#updatePasswordBtn:hover { background:#2ecc71; }
#profileClose { position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff; }

#profileUsername { color:#fff; } 

.togglePassword {
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  cursor:pointer; font-size:16px; user-select:none;
}

.top-right-actions { position: fixed; top: 10px; right: 20px; display:flex; align-items:center; gap:10px; z-index:1000; }
#profileIcon { position: relative; background: #27ae60; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; z-index:10; }
#messageBtn { width:45px; height:45px; border-radius:50%; background:#3498db; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; position:relative; box-shadow:0 4px 10px rgba(0,0,0,0.25); }
#messageBadge { position:absolute; top:-5px; right:-5px; background:#2ecc71; color:white; font-size:12px; font-weight:700; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

#cargoBtn { padding: 10px 12px; background:#f39c12; color:#fff; border:none; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; }
#cargoBtn:hover { background:#e67e22; }
#logoutBtn { padding: 10px 12px; background:#e74c3c; color:#fff; border:none; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; }
#logoutBtn:hover { background:#c0392b; }

#messageModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:450px; background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:10000; max-height:80%; overflow-y:auto; flex-direction:column; }
#messageModal h3 { margin-bottom:15px; text-align:center; }
#messageModal .modalClose { position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff; }
.message-item { background: rgba(255,255,255,0.1); padding:10px; border-radius:12px; margin-bottom:10px; cursor:pointer; transition:0.3s; }
.message-item:hover { background: rgba(255,255,255,0.25); display:flex; justify-content: space-between; align-items:center; }
#messageDetail { display:none; flex-direction:column; gap:8px; background: rgba(50,50,50,0.95); padding:15px; border-radius:12px; margin-top:10px; }
#messageDetail h4 { margin:0; font-size:16px; }
#deleteMessageBtn { background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:600; align-self:flex-end; }

@media (min-width:600px){ .devriye-item { flex-direction: row; justify-content: space-between; align-items: center; } .devriye-left { margin-right:20px; } .devriye-status { margin-top:0; } }
@media (max-width:600px){ .security-item { flex-direction: row; align-items: center; justify-content: space-between; } }

body, div, span, p, h1, h2, h3, h4, h5, h6, label, input, button {
    user-select: none;
    -webkit-user-select: none; 
    -moz-user-select: none;    
    -ms-user-select: none;     
}
</style>
</head>
<body>

<div class="container">
  <h1>CGA Güvenlik Sistemi</h1>
  <h2>Site Sakini Paneli</h2>

  <div id="profileModal">
    <span id="profileClose">✖</span>
    <h3>Profil</h3>
    <label>Kullanıcı Adı (değiştirilemez)</label>
    <input type="text" id="profileUsername" disabled>
    <label>ESKİ ŞİFRE</label>
    <div style="position:relative;">
      <input type="password" id="oldPassword">
      <span class="togglePassword" data-target="oldPassword">👀</span>
    </div>
    <label>YENİ ŞİFRE</label>
    <div style="position:relative;">
      <input type="password" id="newPassword">
      <span class="togglePassword" data-target="newPassword">👀</span>
    </div>
    <button id="updatePasswordBtn">Şifreyi Güncelle</button>
    <div id="profileMessage" style="margin-top:10px;font-size:14px;"></div>
  </div>

  <div class="panel">
    <h3>Güvenlik Durumu</h3>
    <div id="securityStatus" class="status">Yükleniyor...</div>
  </div>

  <div class="panel">
    <h3>Devriye Geçmişi</h3>
    <label for="filterDate">Tarih Filtrele:</label>
    <input type="date" id="filterDate">
    <div class="devriye-list" id="devriyeHistory"></div>
  </div>
</div>

<div class="top-right-actions">
  <div id="messageNotificationWrapper">
    <div id="messageBtn" title="Mesajlar">✉<div id="messageBadge">0</div></div>
  </div>
  <div id="profileIcon" title="Profil">👤</div>
  <button id="cargoBtn" title="Kargomu Al">Kargomu Al</button>
  <button id="logoutBtn" title="Çıkış">Çıkış</button>
</div>

<!-- ================= MESAJ MODAL ================= -->
<div id="messageModal">
  <span class="modalClose">✖</span>
  <h3>Mesajlar</h3>
  <div id="messageList"></div>
  <div id="messageDetail">
    <h4 id="detailSubject"></h4>
    <p id="detailContent"></p>
    <button id="deleteMessageBtn">Sil</button>
  </div>
</div>
<script src="engel.js"></script>
<script type="module">
import { firebaseConfig } from './config.js';
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";


const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let storedUser = sessionStorage.getItem("currentUser");
let currentUser = storedUser ? JSON.parse(storedUser).username : null;
if(!currentUser){ alert("Lütfen önce giriş yapın!"); window.location.href="index.html"; }

const securityStatus=document.getElementById("securityStatus"),
      devriyeHistoryEl=document.getElementById("devriyeHistory"),
      filterDate=document.getElementById("filterDate"),
      profileModal=document.getElementById("profileModal"),
      profileIcon=document.getElementById("profileIcon"),
      profileClose=document.getElementById("profileClose"),
      profileUsername=document.getElementById("profileUsername"),
      oldPassword=document.getElementById("oldPassword"),
      newPassword=document.getElementById("newPassword"),
      updatePasswordBtn=document.getElementById("updatePasswordBtn"),
      profileMessage=document.getElementById("profileMessage"),
      messageBtn=document.getElementById("messageBtn"),
      messageBadge=document.getElementById("messageBadge"),
      messageModal=document.getElementById("messageModal"),
      messageList=document.getElementById("messageList"),
      messageDetail=document.getElementById("messageDetail"),
      detailSubject=document.getElementById("detailSubject"),
      detailContent=document.getElementById("detailContent"),
      deleteMessageBtn=document.getElementById("deleteMessageBtn"),
      logoutBtn=document.getElementById("logoutBtn"),
      cargoBtn=document.getElementById("cargoBtn");

profileUsername.value=currentUser;
profileIcon.addEventListener('click',()=>{profileModal.style.display='block';});
profileClose.addEventListener('click',()=>{profileModal.style.display='none';});
logoutBtn.addEventListener('click',()=>{sessionStorage.removeItem("currentUser"); window.location.href='index.html';});
cargoBtn.addEventListener('click',()=>window.location.href='kargom.html');

updatePasswordBtn.addEventListener('click',async()=>{
  profileMessage.innerText='';
  const oldPwd=oldPassword.value; const newPwd=newPassword.value;
  if(!oldPwd||!newPwd){profileMessage.innerText='Lütfen eski ve yeni şifreyi giriniz.'; return;}
  try{
    const snapshot=await get(ref(db,'users/'+currentUser));
    if(!snapshot.exists()){profileMessage.innerText='Kullanıcı bulunamadı.'; return;}
    const userData=snapshot.val();
    if(userData.password!==oldPwd){profileMessage.innerText='Eski şifre hatalı.'; return;}
    await update(ref(db,'users/'+currentUser),{password:newPwd});
    profileMessage.innerText='Şifre başarıyla güncellendi.';
    setTimeout(()=>{profileMessage.innerText='';}, 3000);
    oldPassword.value=''; newPassword.value='';
  }catch(err){profileMessage.innerText='Hata oluştu: '+err.message;}
});
[oldPassword, newPassword].forEach(input => { input.addEventListener('input', () => { input.value = input.value.toUpperCase(); }); });
document.querySelectorAll('.togglePassword').forEach(icon=>{ icon.addEventListener('click', ()=>{ const input = document.getElementById(icon.dataset.target); input.type = input.type === 'password' ? 'text' : 'password'; }); });

onValue(ref(db,'nobetRecords'),snapshot=>{
  const val=snapshot.val(); securityStatus.innerHTML='';
  if(!val){ securityStatus.innerText='Şu anda nöbette güvenlik yok.'; return; }
  let count=0;
  for(const key in val){
    const record=val[key];
    if(record.status==='started'){
      const userName=record.startBy, shift=record.shift, startTime=new Date(record.startTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      get(ref(db,'users/'+userName)).then(userSnap=>{
        if(!userSnap.exists()) return;
        const phone=userSnap.val()?.phone||'';
        const div=document.createElement('div'); div.classList.add('security-item');
        div.innerHTML=`<div class="security-left"><span style="color:#2ecc71; font-weight:bold;">[●]</span><span class="security-name">${userName} Nöbette</span> | ${shift} Vardiyası | ${record.startPoint}</div><button class="call-btn" onclick="window.location.href='tel:${phone}'">📞Ara</button>`;
        securityStatus.appendChild(div);
      });
      count++;
    }
  }
  if(count===0) securityStatus.innerText='Şu anda nöbette güvenlik yok.';
});

// === DEVRIYE GEÇMİŞİ ===
let allDevriyeHistory=[], tumNoktalar=[];
onValue(ref(db,'qrCodes'), snapshot=>{ 
  const val=snapshot.val(); 
  tumNoktalar=[]; 
  if(val) for(const key in val){ const qr=val[key]; if(qr.name) tumNoktalar.push(qr.name); }
});
filterDate.value=getTurkeyToday();
onValue(ref(db,'devriyeHistory'), snapshot=>{
  const val=snapshot.val(); allDevriyeHistory=[];
  if(val){
    for(const userKey in val){
      const userRecords=val[userKey];
      for(const recordKey in userRecords){ 
        const record=userRecords[recordKey]; 
        allDevriyeHistory.push({...record, userName:record.name});
      }
    } 
    allDevriyeHistory.sort((a,b)=>b.timestamp-a.timestamp);
  }
  renderDevriyeHistory();
});
filterDate.addEventListener('change', renderDevriyeHistory);

async function renderDevriyeHistory(){
  const selectedDate = filterDate.value;
  devriyeHistoryEl.innerHTML = '';

  const filtered = allDevriyeHistory.filter(d => {
    const ts = d.timestamp;
    const dateObj = new Date(ts);
    const utc = dateObj.getTime() + (dateObj.getTimezoneOffset() * 60000);
    const turkeyTime = new Date(utc + 3*60*60*1000);
    const year = turkeyTime.getFullYear();
    const month = String(turkeyTime.getMonth()+1).padStart(2,'0');
    const day = String(turkeyTime.getDate()).padStart(2,'0');
    const devriyeDateStr = `${year}-${month}-${day}`;
    return selectedDate ? devriyeDateStr === selectedDate : true;
  });

  for(const d of filtered){
    const div = document.createElement('div'); 
    div.classList.add('devriye-item');
    const left = document.createElement('div'); 
    left.classList.add('devriye-left');

    let pointsHTML = '';

if(d.status.toLowerCase().includes('eksik')){
  let kaydedilenNoktalar = d.points || [];
let qrRefPath;

if(d.block){
  // d.block değerini aynen al, sonuna "qrcodes" ekle
  const blockFieldName = d.block + 'qrcodes';

  const blockSnapshot = await get(ref(db, blockFieldName));
  if(blockSnapshot.exists()){
    qrRefPath = blockFieldName; // blok bazlı QR
  } else {
    qrRefPath = 'qrCodes';      // yoksa genel QR
  }
} else {
  qrRefPath = 'qrCodes';        // block yoksa genel
}



  try{
    const snapshot = await get(ref(db, qrRefPath));
    let blokNoktalar = [];
    if(snapshot.exists()){
      const val = snapshot.val();
      for(const key in val){ if(val[key].name) blokNoktalar.push(val[key].name); }
    }
    const isaretlenmeyen = blokNoktalar.filter(p => !kaydedilenNoktalar.includes(p));
    pointsHTML = `<div class="devriye-points"><strong>Eksik Noktalar:</strong> ${isaretlenmeyen.join(', ')}</div>`;
  }catch(err){ console.error('QR noktaları alınamadı:', err); }
}


    left.innerHTML = `<div style="display:flex; gap:6px;"><strong>Güvenlik:</strong> ${d.userName}</div>
                      <div style="display:flex; gap:6px;"><strong>Tarih:</strong> ${d.displayDate}</div>
                      <div style="display:flex; gap:6px;"><strong>Başlangıç:</strong> ${d.start}</div>
                      <div style="display:flex; gap:6px;"><strong>Bitiş:</strong> ${d.end}</div>
                      ${pointsHTML}`;

    const statusDiv = document.createElement('div'); 
    statusDiv.classList.add('devriye-status'); 
    statusDiv.classList.add(d.status.toLowerCase().includes('tam') ? 'tam' : 'eksik'); 
    statusDiv.innerText = d.status;

    div.appendChild(left); 
    div.appendChild(statusDiv); 
    devriyeHistoryEl.appendChild(div);
  }
}

function getTurkeyToday(){
  const now=new Date();
  const utc=now.getTime() + (now.getTimezoneOffset()*60000);
  const turkey=new Date(utc + 3*60*60*1000);
  const mm=String(turkey.getMonth()+1).padStart(2,'0'), dd=String(turkey.getDate()).padStart(2,'0');
  return `${turkey.getFullYear()}-${mm}-${dd}`;
}

const messagesRef = ref(db,'messages/'+currentUser);
onValue(messagesRef, snapshot=>{
    const val = snapshot.val(); messageList.innerHTML=''; messageDetail.style.display='none'; let count=0;
    if(val){
        const sortedKeys=Object.keys(val).sort((a,b)=>a-b);
        for(const key of sortedKeys){
            const msg=val[key]; count++;
            const div=document.createElement('div'); div.classList.add('message-item');
            div.innerHTML=`<div><strong>${msg.subject}</strong> - ${msg.from}</div>`;
            div.addEventListener('click', ()=>{
                detailSubject.innerText=`${msg.subject} - ${msg.from}`; detailContent.innerText=msg.content;
                deleteMessageBtn.onclick=async()=>{ if(confirm('Mesajı silmek istediğinize emin misiniz?')){ await remove(ref(db,'messages/'+currentUser+'/'+key)); }};
                messageDetail.style.display='flex';
            });
            messageList.appendChild(div);
        }
    }
    messageBadge.innerText=count;
});

messageBtn.addEventListener('click',()=>{ messageModal.style.display='flex'; });
messageModal.querySelector('.modalClose').addEventListener('click',()=>{ messageModal.style.display='none'; messageDetail.style.display='none'; });

</script>

</body>
</html>
